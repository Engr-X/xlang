# Newline (NL) 处理规则说明

## 1. 背景与目标

### 1.1 Kotlin 风格的换行语义

本语言采用 **Kotlin 风格的换行语义**：

- 分号 `;` 是可选的
- 换行可能具有语义，但不总是表示语句结束

### 1.2 处理阶段划分

#### 词法 / 预处理阶段（Newline pass）

- 负责**识别源码中的换行**
- 在 token 流中插入 `NL` 标记

#### 语法分析阶段（Parser）

Parser 决定哪些 `NL`：

- 表示语句结束（terminator）
- 只是布局空白（ignored）

> **newline 模块只负责阶段 1。**

---

## 2. Newline 模块的职责（做什么）

### 2.1 `insertTokenPass ` 的职责

- 根据 token 的 `Position.line` 变化，推断源码中原本存在的换行
- 在合适位置插入 `NL` token

具体规则：

- 当两个相邻 token 的 `line` 不相等时：
  - 说明源码中至少存在一个 `\n`
  - 插入一个 `NL` token
- `{ ... }` 内部的 token **递归应用同样的规则**
- 插入的 `NL` **只表示“这里发生过换行”**，不代表语句结束

---

## 3. Newline 模块明确 *不做* 的事情

### 3.1 `insertTokenPass ` 不负责任何语法决策，包括但不限于：

- 不判断 `NL` 是否等价于 `;`
- 不判断 `if / else` 是否应当绑定
- 不处理 `do ... while` 是否是一条语句
- 不关心 `class`、继承、函数等语法结构
- 不在文件结尾（EOF）强行插入 `NL`

**一句话总结：**

> **Newline 只记录事实（有换行），不做判断（是否断句）。**
