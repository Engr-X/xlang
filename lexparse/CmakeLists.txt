cmake_minimum_required(VERSION 4.1)

project(lexparse LANGUAGES C)

set(SOURCE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/src")
set(BUILD_DIR "${CMAKE_CURRENT_BINARY_DIR}")

set(GHC_PACKAGES
    -package base
    -package containers
    -package mtl
    -package text
    -package regex-tdfa
    -package aeson
    -package aeson-pretty
    -package bytestring
)

set(FILES
    ${SOURCE_DIR}/Main.hs
    ${SOURCE_DIR}/Util/Types.hs
    ${SOURCE_DIR}/Util/Exception.hs
    ${SOURCE_DIR}/Util/Basic.hs
    ${SOURCE_DIR}/Util/FileHelper.hs
    ${SOURCE_DIR}/Data/Trie.hs
    ${SOURCE_DIR}/Lexer/Tokenizer.hs
)

set(OBJECTS
    ${BUILD_DIR}/Main.o
    ${BUILD_DIR}/Util/Types.o
    ${BUILD_DIR}/Util/Exception.o
    ${BUILD_DIR}/Util/Basic.o
    ${BUILD_DIR}/Util/FileHelper.o
    ${BUILD_DIR}/Data/Trie.o
    ${BUILD_DIR}/Lexer/Tokenizer.o
)

add_custom_command(
    OUTPUT ${OBJECTS}
    COMMAND ghc -O3 -c 
            -i${SOURCE_DIR}
            -odir ${BUILD_DIR}
            -hidir ${BUILD_DIR}
            ${FILES}
            ${GHC_PACKAGES}
            -fasm
            # -fllvm
    DEPENDS ${FILES}
    COMMENT "Building haskell objects"
    VERBATIM
)

set(LIB "${BUILD_DIR}/lib/libparser.a")

add_custom_command(
    OUTPUT ${LIB}
    COMMAND ghc -O3 -static -c
            -i${SOURCE_DIR}
            -odir ${BUILD_DIR}
            -hidir ${BUILD_DIR}
            ${FILES}
            ${GHC_PACKAGES}
            -o ${LIB}
    DEPENDS ${HASKELL_FILES}
    COMMENT "Building library libparser.a"
    VERBATIM
)
add_custom_target(
    lexparse ALL
    DEPENDS ${LIB}
)
