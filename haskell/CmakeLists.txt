cmake_minimum_required(VERSION 4.1)

project(xlang_parser LANGUAGES C)

set(SOURCE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/src")
set(BUILD_DIR "${CMAKE_CURRENT_BINARY_DIR}")

set(GHC_PACKAGES
    -package base
    -package containers
    -package mtl
    -package text
    -package regex-tdfa
    -package aeson
    -package aeson-pretty
    -package bytestring
)

set(HASKELL_FILES
    ${SOURCE_DIR}/Main.hs
    ${SOURCE_DIR}/Util/Types.hs
    ${SOURCE_DIR}/Util/Exception.hs
    ${SOURCE_DIR}/Util/Basic.hs
    ${SOURCE_DIR}/Util/FileHelper.hs
    ${SOURCE_DIR}/Data/Trie.hs
    ${SOURCE_DIR}/Lexer/Tokenizer.hs
)

set(HASKELL_OBJECTS
    ${BUILD_DIR}/Main.o
    ${BUILD_DIR}/Util/Types.o
    ${BUILD_DIR}/Util/Exception.o
    ${BUILD_DIR}/Util/Basic.o
    ${BUILD_DIR}/Util/FileHelper.o
    ${BUILD_DIR}/Data/Trie.o
    ${BUILD_DIR}/Lexer/Tokenizer.o
)

add_custom_command(
    OUTPUT ${HASKELL_OBJECTS}
    COMMAND ghc -O3 -shared -c
            -i${SOURCE_DIR}
            -odir ${BUILD_DIR}
            -hidir ${BUILD_DIR}
            ${HASKELL_FILES}
            ${GHC_PACKAGES}
    DEPENDS ${HASKELL_FILES}
    COMMENT "Building all Haskell objects"
    VERBATIM
)

set(STATIC_LIB "${BUILD_DIR}/libxlang_parser.a")

add_custom_command(
    OUTPUT ${STATIC_LIB}
    COMMAND ${CMAKE_AR} rcs ${STATIC_LIB} ${HASKELL_OBJECTS}
    DEPENDS ${HASKELL_OBJECTS}
    COMMENT "Creating static library libxlang_parser.a"
)
